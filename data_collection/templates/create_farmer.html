{% extends "data_collection/templates/base.html" %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <!-- Form Section -->
        <div class="col-md-6">
            <h2 class="mb-3 text-primary">Create a Farmer</h2>

            <form method="post" enctype="multipart/form-data" class="card p-4 shadow">  <!-- ✅ Add enctype -->
                {% csrf_token %}            
                <div class="mb-3">
                    <label for="districtSelect" class="form-label">Select District</label>
                    <select id="districtSelect" name="district" class="form-control">
                        <option value="">Loading districts...</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label for="blockSelect" class="form-label">Select Block</label>
                    <select id="blockSelect" name="block" class="form-control" disabled>
                        <option value="">-- Select Block --</option>
                    </select>
                </div>
                

                {% comment %} <div class="mb-3">
                    <label class="form-label">Village</label>
                    {{ form.village }}
                </div>

                <div class="mb-3">
                    <label class="form-label">Pincode</label>
                    {{ form.pincode }}
                    {% if form.pincode.errors %}
                        <div class="text-danger">
                            {{ form.pincode.errors }}
                        </div>
                    {% endif %}
                </div> {% endcomment %}
                <div class="mb-3">
                    <label class="form-label">Village</label>
                    <input type="text" id="village" name="village" class="form-control" required>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Pincode</label>
                    <input type="text" id="pincode" name="pincode" class="form-control" required>
                </div>

                <div class="mb-3">
                    <label class="form-label">First Name</label>
                    {{ form.first_name }}
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Last Name</label>
                    {{ form.last_name }}
                </div>
                <div class="mb-3">
                    <label class="form-label">Mobile Number</label>
                    {{ form.mobile_number }}
                    {% if form.mobile_number.errors %}
                        <div class="text-danger">
                            {{ form.mobile_number.errors }}
                        </div>
                    {% endif %}
                </div>

                <div class="mb-3">
                    <label class="form-label">Gender</label>
                    {{ form.gender }}
                </div>

                <div class="mb-3">
                    <label class="form-label">Guardian Name</label>
                    {{ form.guardian_name }}
                </div>

                <!-- Hidden Fields for GeoLocation -->
                <input type="hidden" name="latitude" id="latitude">
                <input type="hidden" name="longitude" id="longitude">

                <button type="submit" class="btn btn-success w-100">Submit</button>
            </form>
        </div>

        <!-- Map Section -->
        <div class="col-md-6">
            <h3 class="mb-3 text-primary">Select Farmer's Location</h3>
            <div id="map" class="shadow rounded" style="height: 400px;"></div>
        </div>
    </div>
</div>

<!-- Leaflet CSS & JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/idb/7.1.1/idb.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
        // Base map layers
        var streets = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors',
            maxZoom: 22  // ✅ Allow max zoom
        });
    
        var satellite = L.tileLayer('/tiles/s/{z}/{x}/{y}', {
            attribution: '&copy; Google Satellite',
            maxZoom: 22
        });
        
        var terrain = L.tileLayer('/tiles/p/{z}/{x}/{y}', {
            attribution: '&copy; Google Terrain',
            maxZoom: 22
        });
        
        var hybrid = L.tileLayer('/tiles/y/{z}/{x}/{y}', {
            attribution: '&copy; Google Hybrid',
            maxZoom: 22
        });
    
        var esri = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: '&copy; Esri World Imagery',
            maxZoom: 22
        });
    
        // Overlay for Place Names & Boundaries
        var esriLabels = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}', {
            attribution: '&copy; Esri, HERE, Garmin',
            maxZoom: 22
        });
        var esriClarity = L.tileLayer(
            'https://clarity.maptiles.arcgis.com/arcgis/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: '&copy; Esri, Maxar, Earthstar Geographics',
            maxZoom: 22  // ✅ Allows deeper zoom levels
        });       
    
       
        var map = L.map('map', {
            center: [23.6157, 81.9195], 
            zoom: 15,
            maxZoom: 22,  
            layers: hybrid  
        });
    
        // Layer control to switch between different maps
        var baseMaps = {
            "Streets": streets,
            "Google Satellite": satellite,
            "Google Terrain": terrain,
            "Google Hybrid": hybrid,
            "Esri World Imagery": esri,
            "Esri Clarity": esriClarity
        };
    
        var overlayMaps = {
            "Place Names & Boundaries": esriLabels
        };
    
        L.control.layers(baseMaps, overlayMaps).addTo(map);


        // Custom control for "Locate Me" button
        L.Control.Locate = L.Control.extend({
            onAdd: function(map) {
                var button = L.DomUtil.create('button', 'leaflet-bar leaflet-control leaflet-control-custom');
                button.innerHTML = '📍'; // Location icon
                button.style.backgroundColor = 'white';
                button.style.width = '40px';
                button.style.height = '40px';
                button.style.border = '2px solid gray';
                button.style.borderRadius = '5px';
                button.style.cursor = 'pointer';

                // Click event to find user location
                button.onclick = function() {
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(
                            function(position) {
                                var lat = position.coords.latitude;
                                var lng = position.coords.longitude;
                                
                                map.setView([lat, lng], 14);

                                // Remove old marker before adding new one
                                if (window.marker) {
                                    map.removeLayer(window.marker);
                                }

                                window.marker = L.marker([lat, lng]).addTo(map)
                                    .bindPopup("Your Current Location").openPopup();

                                document.getElementById("latitude").value = lat;
                                document.getElementById("longitude").value = lng;
                            },
                            function(error) {
                                alert("Failed to get location. Ensure GPS is enabled.");
                            },
                            { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                        );
                    } else {
                        alert("Geolocation is not supported by your browser.");
                    }
                };

                return button;
            },

            onRemove: function(map) {
                // Nothing needed here
            }
        });

        // Add Locate Me button to the map
        L.control.locate = function(opts) {
            return new L.Control.Locate(opts);
        };

        L.control.locate({ position: 'topright' }).addTo(map);

    

   
    

    
    
    window.marker = null;
    console.log("Map initialized");
    
    // Function to fetch village and pincode using Nominatim API
    function fetchLocationDetails(lat, lng) {
        const nominatimURL = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`;
    
        fetch(nominatimURL)
            .then(response => response.json())
            .then(data => {
                console.log("Nominatim API Response:", data);
    
                // Extract village and pincode from response
                const village = data.address.village || data.address.town || data.address.hamlet || "";
                const pincode = data.address.postcode || "";
    
                // Update the form fields
                document.getElementById("village").value = village;
                document.getElementById("pincode").value = pincode;
            })
            .catch(error => {
                console.error("Error fetching location details:", error);
                alert("Failed to get village and pincode. Please enter manually.");
            });
    }
    
    // Get user's current location
    if (navigator.geolocation) {
        console.log("Requesting geolocation...");
        navigator.geolocation.getCurrentPosition(
            function (position) {
                console.log("Geolocation success:", position.coords.latitude, position.coords.longitude);
                var lat = position.coords.latitude;
                var lng = position.coords.longitude;
    
                map.setView([lat, lng], 14);
    
                // Remove old marker before adding new one
                if (window.marker) {
                    map.removeLayer(window.marker);
                }
    
                window.marker = L.marker([lat, lng]).addTo(map)
                    .bindPopup("Your Current Location").openPopup();
    
                document.getElementById("latitude").value = lat;
                document.getElementById("longitude").value = lng;
    
                // Fetch village & pincode using Nominatim API
                fetchLocationDetails(lat, lng);
            },
            function (error) {
                console.error("Geolocation error:", error.code, error.message);
                switch (error.code) {
                    case error.PERMISSION_DENIED:
                        alert("Location access denied. Please enable location services.");
                        break;
                    case error.POSITION_UNAVAILABLE:
                        alert("Location information is unavailable.");
                        break;
                    case error.TIMEOUT:
                        alert("Location request timed out.");
                        break;
                    default:
                        alert("An unknown error occurred.");
                }
            },
            {
                enableHighAccuracy: true,
                timeout: 10000, // 10 seconds timeout
                maximumAge: 0
            }
        );
    } else {
        console.error("Geolocation not supported");
        alert("Geolocation is not supported by your browser.");
    }
    
    // Allow user to manually select a location by clicking on the map
    map.on('click', function (e) {
        console.log("Map clicked:", e.latlng.lat, e.latlng.lng);
        var lat = e.latlng.lat;
        var lng = e.latlng.lng;
    
        document.getElementById("latitude").value = lat;
        document.getElementById("longitude").value = lng;
    
        // Remove old marker before adding new one
        if (window.marker) {
            map.removeLayer(window.marker);
        }
    
        window.marker = L.marker([lat, lng]).addTo(map)
            .bindPopup("Selected Location").openPopup();
    
        // Fetch village & pincode based on selected location
        fetchLocationDetails(lat, lng);
    });
        
    
    // States, districts, blocks handling
    const districtSelect = document.getElementById("districtSelect");
    const blockSelect = document.getElementById("blockSelect");

    // Fetch Maharashtra districts on page load
    fetch(`/api/districts/9/`) // State ID for Maharashtra is 9
        .then(response => response.json())
        .then(districts => {
            districtSelect.innerHTML = '<option value="">-- Select District --</option>';
            districts.forEach(district => {
                const option = document.createElement("option");
                option.value = district.id;
                option.textContent = district.display_name;
                districtSelect.appendChild(option);
            });
            districtSelect.disabled = false;
        })
        .catch(error => {
            console.error("Error fetching districts:", error);
            alert("Failed to load districts. Please try again later.");
        });

    // Fetch blocks based on selected district
    districtSelect.addEventListener("change", function () {
        const districtId = this.value;
        if (!districtId) {
            blockSelect.innerHTML = '<option value="">-- Select Block --</option>';
            blockSelect.disabled = true;
            return;
        }

        blockSelect.innerHTML = '<option>Loading...</option>';
        blockSelect.disabled = true;

        fetch(`/api/blocks/${districtId}/`)
            .then(response => response.json())
            .then(blocks => {
                blockSelect.innerHTML = '<option value="">-- Select Block --</option>';
                blocks.forEach(block => {
                    const option = document.createElement("option");
                    option.value = block.id;
                    option.textContent = block.display_name;
                    blockSelect.appendChild(option);
                });
                blockSelect.disabled = false;
            })
            .catch(error => {
                console.error("Error fetching blocks:", error);
                alert("Failed to load blocks. Please try again later.");
            });
    });
});
</script>

{% endblock %}
