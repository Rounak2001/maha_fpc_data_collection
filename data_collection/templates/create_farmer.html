


{% extends "data_collection/templates/base.html" %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-lg-6 mb-4">
            <div class="d-flex align-items-center mb-3">
                <i data-lucide="user-plus" class="text-primary me-2" size="28"></i>
                <h2 class="mb-0 text-primary">Create a Farmer</h2>
            </div>
            
            <div class="card shadow-sm">
                <div class="card-body p-4">
                    <form id="farmerForm" method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        
                        <!-- Location Section -->
                        <div class="mb-4">
                            <h5 class="card-title mb-3 d-flex align-items-center">
                                <i data-lucide="map-pin" class="text-primary me-2" size="18"></i>
                                <span>Location Details</span>
                            </h5>
                            
                            <div class="mb-3">
                                <label for="districtSelect" class="form-label">District</label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i data-lucide="map" size="18"></i>
                                    </span>
                                    <select id="districtSelect" name="district" class="form-select">
                                        <option value="">Loading districts...</option>
                                    </select>
                                </div>
                                <div id="districtLoading" class="text-muted mt-1 small" style="display: none;">
                                    <span class="spinner-border spinner-border-sm"></span> Loading districts...
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="blockSelect" class="form-label">Block</label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i data-lucide="map-pin" size="18"></i>
                                    </span>
                                    <select id="blockSelect" name="block_id" class="form-select" disabled>
                                        <option value="">-- Select Block --</option>
                                    </select>
                                </div>
                                <div id="blockLoading" class="text-muted mt-1 small" style="display: none;">
                                    <span class="spinner-border spinner-border-sm"></span> Loading blocks...
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Village</label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i data-lucide="home" size="18"></i>
                                        </span>
                                        <input type="text" id="village" name="village" class="form-control" required>
                                    </div>
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Pincode</label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i data-lucide="mail" size="18"></i>
                                        </span>
                                        <input type="text" id="pincode" name="pincode" class="form-control" required>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Personal Details Section -->
                        <div class="mb-4">
                            <h5 class="card-title mb-3 d-flex align-items-center">
                                <i data-lucide="user" class="text-primary me-2" size="18"></i>
                                <span>Personal Details</span>
                            </h5>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">First Name</label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i data-lucide="user" size="18"></i>
                                        </span>
                                        {{ form.first_name }}
                                    </div>
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Last Name</label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i data-lucide="user" size="18"></i>
                                        </span>
                                        {{ form.last_name }}
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Mobile Number</label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i data-lucide="phone" size="18"></i>
                                    </span>
                                    {{ form.mobile_number }}
                                </div>
                                {% if form.mobile_number.errors %}
                                    <div class="text-danger mt-1">
                                        {{ form.mobile_number.errors }}
                                    </div>
                                {% endif %}
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Gender</label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i data-lucide="users" size="18"></i>
                                        </span>
                                        {{ form.gender }}
                                    </div>
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Guardian Name</label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i data-lucide="user-check" size="18"></i>
                                        </span>
                                        {{ form.guardian_name }}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Hidden Fields for GeoLocation -->
                        <input type="hidden" name="latitude" id="latitude">
                        <input type="hidden" name="longitude" id="longitude">

                        <!-- Submit Button -->
                        <button type="submit" class="btn btn-success w-100 d-flex align-items-center justify-content-center" id="submitFarmerBtn">
                            <i data-lucide="save" class="me-2" size="18"></i>
                            <span>Submit Farmer</span>
                        </button>
                    </form>
                </div>
            </div>

            <!-- Message Placeholder -->
            <div id="message" class="mt-3"></div>
        </div>

        <!-- Map Section -->
        <div class="col-lg-6">
            <div class="d-flex align-items-center mb-3">
                <i data-lucide="map" class="text-primary me-2" size="28"></i>
                <h3 class="mb-0 text-primary">Select Farmer's Location</h3>
            </div>
            
            <div class="card shadow-sm mb-4">
                <div class="card-body p-0">
                    <div id="map-loading" class="position-absolute top-50 start-50 translate-middle" style="z-index: 100; display: none;">
                        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                            <span class="visually-hidden">Loading map...</span>
                        </div>
                    </div>
                    <div id="map" class="rounded" style="height: 450px;"></div>
                </div>
                <div class="card-footer bg-light">
                    <small class="text-muted d-flex align-items-center">
                        <i data-lucide="info" class="me-2" size="16"></i>
                        Click anywhere on the map to select a location
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Leaflet CSS & JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/idb/7.1.1/idb.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
    // Initialize Lucide icons
    lucide.createIcons();
    
    // Show map loading indicator
    document.getElementById("map-loading").style.display = "flex";
    
    // Base map layers
    var streets = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors',
        maxZoom: 22  // ✅ Allow max zoom
    });

    var satellite = L.tileLayer('/tiles/s/{z}/{x}/{y}', {
        attribution: '&copy; Google Satellite',
        maxZoom: 22
    });
    
    var terrain = L.tileLayer('/tiles/p/{z}/{x}/{y}', {
        attribution: '&copy; Google Terrain',
        maxZoom: 22
    });
    
    var hybrid = L.tileLayer('/tiles/y/{z}/{x}/{y}', {
        attribution: '&copy; Google Hybrid',
        maxZoom: 22
    });

    var esri = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: '&copy; Esri World Imagery',
        maxZoom: 22
    });

    // Overlay for Place Names & Boundaries
    var esriLabels = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}', {
        attribution: '&copy; Esri, HERE, Garmin',
        maxZoom: 22
    });
    
    var esriClarity = L.tileLayer(
        'https://clarity.maptiles.arcgis.com/arcgis/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: '&copy; Esri, Maxar, Earthstar Geographics',
        maxZoom: 22  // ✅ Allows deeper zoom levels
    });       

    var map = L.map('map', {
        center: [23.6157, 81.9195], 
        zoom: 15,
        maxZoom: 22,  
        layers: hybrid  
    });

    // Hide loading indicator once map loads
    map.whenReady(function() {
        document.getElementById("map-loading").style.display = "none";
    });

    // Layer control to switch between different maps
    var baseMaps = {
        "Streets": streets,
        "Google Satellite": satellite,
        "Google Terrain": terrain,
        "Google Hybrid": hybrid,
        "Esri World Imagery": esri,
        "Esri Clarity": esriClarity
    };

    var overlayMaps = {
        "Place Names & Boundaries": esriLabels
    };

    L.control.layers(baseMaps, overlayMaps).addTo(map);

    // Custom control for "Locate Me" button with modern styling
    L.Control.Locate = L.Control.extend({
        onAdd: function(map) {
            var button = L.DomUtil.create('button', 'leaflet-bar leaflet-control leaflet-control-custom');
            button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="1"/><line x1="12" y1="8" x2="12" y2="4"/><line x1="12" y1="20" x2="12" y2="16"/><line x1="8" y1="12" x2="4" y2="12"/><line x1="20" y1="12" x2="16" y2="12"/></svg>';
            button.style.backgroundColor = 'white';
            button.style.width = '34px';
            button.style.height = '34px';
            button.style.border = 'none';
            button.style.borderRadius = '4px';
            button.style.cursor = 'pointer';
            button.style.boxShadow = '0 2px 6px rgba(0,0,0,0.3)';
            button.style.display = 'flex';
            button.style.alignItems = 'center';
            button.style.justifyContent = 'center';
            button.title = "Find my location";

            // Hover effect
            button.onmouseover = function() {
                this.style.backgroundColor = '#f8f9fa';
            };
            button.onmouseout = function() {
                this.style.backgroundColor = 'white';
            };

            // Click event to find user location
            button.onclick = function() {
                // Show loading indicator on button
                const originalHTML = this.innerHTML;
                this.innerHTML = '<div class="spinner-border spinner-border-sm text-primary" role="status"><span class="visually-hidden">Loading...</span></div>';
                this.disabled = true;
                
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        function(position) {
                            var lat = position.coords.latitude;
                            var lng = position.coords.longitude;
                            
                            map.setView([lat, lng], 16);

                            // Remove old marker before adding new one
                            if (window.marker) {
                                map.removeLayer(window.marker);
                            }

                            // Custom marker with pulse effect
                            var pulseIcon = L.divIcon({
                                className: 'pulse-icon',
                                html: '<div class="pulse-inner"></div>',
                                iconSize: [20, 20]
                            });

                            window.marker = L.marker([lat, lng], {
                                icon: L.divIcon({
                                    className: 'my-custom-pin',
                                    html: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="#1e6f5c" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>',
                                    iconSize: [40, 40],
                                    iconAnchor: [12, 24],
                                    popupAnchor: [0, -20]
                                })
                            }).addTo(map)
                                .bindPopup("<b>Your Current Location</b>").openPopup();

                            document.getElementById("latitude").value = lat;
                            document.getElementById("longitude").value = lng;
                            
                            // Fetch village & pincode based on selected location
                            fetchLocationDetails(lat, lng);
                            
                            // Reset button
                            button.innerHTML = originalHTML;
                            button.disabled = false;
                        },
                        function(error) {
                            // Reset button first
                            button.innerHTML = originalHTML;
                            button.disabled = false;
                            
                            // Show error with custom styling
                            let errorMsg = "Failed to get location. ";
                            switch (error.code) {
                                case error.PERMISSION_DENIED:
                                    errorMsg += "Please enable location services.";
                                    break;
                                case error.POSITION_UNAVAILABLE:
                                    errorMsg += "Location information is unavailable.";
                                    break;
                                case error.TIMEOUT:
                                    errorMsg += "Location request timed out.";
                                    break;
                                default:
                                    errorMsg += "An unknown error occurred.";
                            }
                            
                            const errorToast = document.createElement('div');
                            errorToast.className = 'alert alert-danger position-fixed bottom-0 start-50 translate-middle-x mb-4 shadow';
                            errorToast.style.zIndex = 2000;
                            errorToast.style.maxWidth = '90%';
                            errorToast.style.width = '400px';
                            errorToast.innerHTML = `<div class="d-flex align-items-center"><i data-lucide="alert-circle" class="me-2"></i> ${errorMsg}</div>`;
                            document.body.appendChild(errorToast);
                            
                            // Initialize icon in the error message
                            lucide.createIcons();
                            
                            // Remove after 5 seconds
                            setTimeout(() => {
                                errorToast.remove();
                            }, 5000);
                        },
                        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                    );
                } else {
                    alert("Geolocation is not supported by your browser.");
                    button.innerHTML = originalHTML;
                    button.disabled = false;
                }
            };

            return button;
        },

        onRemove: function(map) {
            // Nothing needed here
        }
    });

    // Add Locate Me button to the map
    L.control.locate = function(opts) {
        return new L.Control.Locate(opts);
    };

    L.control.locate({ position: 'topright' }).addTo(map);

    window.marker = null;
    console.log("Map initialized");
    
    // Function to fetch village and pincode using Nominatim API
    function fetchLocationDetails(lat, lng) {
        const nominatimURL = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`;
    
        fetch(nominatimURL)
            .then(response => response.json())
            .then(data => {
                console.log("Nominatim API Response:", data);
    
                // Extract village and pincode from response
                const village = data.address.village || data.address.town || data.address.hamlet || "";
                const pincode = data.address.postcode || "";
    
                // Update the form fields
                document.getElementById("village").value = village;
                document.getElementById("pincode").value = pincode;
            })
            .catch(error => {
                console.error("Error fetching location details:", error);
                alert("Failed to get village and pincode. Please enter manually.");
            });
    }
    // Detect if user is on mobile
    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

    // Adjust geolocation options based on device
    const geoOptions = {
        enableHighAccuracy: !isMobile, // Use high accuracy only on desktop
        timeout: isMobile ? 20000 : 10000, // Longer timeout for mobile
        maximumAge: isMobile ? 60000 : 0 // Allow cached positions on mobile
    };

    // Show loading indicator
    function showLoading() {
        // Create or show loading element
        const loadingEl = document.getElementById('location-loading') || 
                        document.createElement('div');
        loadingEl.id = 'location-loading';
        loadingEl.textContent = 'Fetching your location...';
        loadingEl.style.cssText = 'position:absolute;top:10px;right:10px;background:white;padding:10px;border-radius:4px;z-index:1000;';
        document.body.appendChild(loadingEl);
    }

    function hideLoading() {
        const loadingEl = document.getElementById('location-loading');
        if (loadingEl) loadingEl.style.display = 'none';
    }
    // Get user's current location
    if (navigator.geolocation) {
        console.log("Requesting geolocation...");
        navigator.geolocation.getCurrentPosition(
            function (position) {
                console.log("Geolocation success:", position.coords.latitude, position.coords.longitude);
                var lat = position.coords.latitude;
                var lng = position.coords.longitude;
    
                map.setView([lat, lng], 14);
    
                // Remove old marker before adding new one
                if (window.marker) {
                    map.removeLayer(window.marker);
                }
    
                window.marker = L.marker([lat, lng]).addTo(map)
                    .bindPopup("Your Current Location").openPopup();
    
                document.getElementById("latitude").value = lat;
                document.getElementById("longitude").value = lng;
    
                // Fetch village & pincode using Nominatim API
                fetchLocationDetails(lat, lng);
            },
            function (error) {
                console.error("Geolocation error:", error.code, error.message);
                switch (error.code) {
                    case error.PERMISSION_DENIED:
                        alert("Location access denied. Please enable location services.");
                        break;
                    case error.POSITION_UNAVAILABLE:
                        alert("Location information is unavailable.");
                        break;
                    case error.TIMEOUT:
                        alert("Location request timed out.");
                        break;
                    default:
                        alert("An unknown error occurred.");
                }
            },
            {
                enableHighAccuracy: true,
                timeout: 10000, // 10 seconds timeout
                maximumAge: 0
            }
        );
    } else {
        console.error("Geolocation not supported");
        alert("Geolocation is not supported by your browser.");
    }
    
    // Allow user to manually select a location by clicking on the map
    map.on('click', function (e) {
        console.log("Map clicked:", e.latlng.lat, e.latlng.lng);
        var lat = e.latlng.lat;
        var lng = e.latlng.lng;
    
        document.getElementById("latitude").value = lat;
        document.getElementById("longitude").value = lng;
    
        // Remove old marker before adding new one
        if (window.marker) {
            map.removeLayer(window.marker);
        }
    
        window.marker = L.marker([lat, lng]).addTo(map)
            .bindPopup("Selected Location").openPopup();
    
        // Fetch village & pincode based on selected location
        fetchLocationDetails(lat, lng);
    });
        
    
    // States, districts, blocks handling
    const districtSelect = document.getElementById("districtSelect");
    const blockSelect = document.getElementById("blockSelect");

    // Fetch Maharashtra districts on page load
    fetch(`/api/districts/9/`) // State ID for Maharashtra is 9
        .then(response => response.json())
        .then(districts => {
            districtSelect.innerHTML = '<option value="">-- Select District --</option>';
            districts.forEach(district => {
                const option = document.createElement("option");
                option.value = district.id;
                option.textContent = district.display_name;
                districtSelect.appendChild(option);
            });
            districtSelect.disabled = false;
        })
        .catch(error => {
            console.error("Error fetching districts:", error);
            alert("Failed to load districts. Please try again later.");
        });

    // Fetch blocks based on selected district
    districtSelect.addEventListener("change", function () {
        const districtId = this.value;
        if (!districtId) {
            blockSelect.innerHTML = '<option value="">-- Select Block --</option>';
            blockSelect.disabled = true;
            return;
        }

        blockSelect.innerHTML = '<option>Loading...</option>';
        blockSelect.disabled = true;

        fetch(`/api/blocks/${districtId}/`)
            .then(response => response.json())
            .then(blocks => {
                blockSelect.innerHTML = '<option value="">-- Select Block --</option>';
                blocks.forEach(block => {
                    const option = document.createElement("option");
                    option.value = block.id;
                    option.textContent = block.display_name;
                    blockSelect.appendChild(option);
                });
                blockSelect.disabled = false;
            })
            .catch(error => {
                console.error("Error fetching blocks:", error);
                alert("Failed to load blocks. Please try again later.");
            });
    });
});
document.addEventListener("DOMContentLoaded", function () {
    const farmerForm = document.getElementById("farmerForm");
    const messageDiv = document.getElementById("message");

    // Handle form submission via AJAX
    farmerForm.addEventListener("submit", async function (event) {
        event.preventDefault(); // Prevent default form submission

        // Show loading message and hide the form
        const submitButton = document.getElementById("submitFarmerBtn");
        submitButton.disabled = true; // Disable the submit button
        farmerForm.style.display = "none"; // Hide the form
        messageDiv.innerHTML = `
            <div class="alert alert-info">
                Uploading data, please wait...
            </div>
        `;

        try {
            // Gather form data
            const formData = new FormData(farmerForm);

            // Send AJAX request
            const response = await fetch("{% url 'create_farmer' %}", {
                method: "POST",
                body: formData,
                headers: { "X-Requested-With": "XMLHttpRequest" }
            });

            const data = await response.json();

            if (data.success) {
                // Success message
                messageDiv.innerHTML = `
                    <div class="alert alert-success mt-3">
                        <p>✅ Farmer created successfully!</p>
                    </div>
                `;

                // Redirect to the farm creation page after a short delay
                setTimeout(() => {
                    window.location.href = `/add_farm/${data.farmer_id}/`;
                }, 1000); // Optional delay to show success message briefly
            } else {
                // Display error message
                messageDiv.innerHTML = `
                    <div class="alert alert-danger">
                        Error: ${JSON.stringify(data.errors || "Unknown error")}
                    </div>
                `;
                farmerForm.style.display = "block"; // Re-enable the form
                submitButton.disabled = false; // Re-enable the submit button
            }
        } catch (error) {
            console.error("Error:", error);
            messageDiv.innerHTML = `
                <div class="alert alert-danger">
                    An unexpected error occurred. Please try again.
                </div>
            `;
            farmerForm.style.display = "block"; // Re-enable the form
            submitButton.disabled = false; // Re-enable the submit button
        }
    });
});
</script>
{% endblock %}