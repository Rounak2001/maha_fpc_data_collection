{% extends "data_collection/templates/base.html" %}
{% load static %}

{% block content %}

<style>
    /* Form styling - matching the base template */
    .form-section {
        margin-bottom: 2rem;
    }
    
    .section-heading {
        color: var(--primary-color);
        font-weight: 600;
        margin-bottom: 1.25rem;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .subsection-heading {
        color: var(--primary-color);
        font-weight: 500;
        margin: 1.5rem 0 1rem;
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 1.25rem;
    }
    
    .card-form {
        border: none;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .card-form:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }
    
    /* Form controls - matching base styles */
    .form-control, .form-select {
        padding: 0.6rem 1rem;
        border-radius: 6px;
        border: 1px solid #ced4da;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: var(--primary-light);
        box-shadow: 0 0 0 0.25rem rgba(41, 187, 137, 0.25);
    }
    
    /* Button styling */
    .btn-action {
        font-weight: 500;
        border-radius: 6px;
        transition: all 0.2s ease;
        padding: 0.75rem 1.5rem;
        margin-top: 0.5rem;
    }
    
    .btn-action:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .btn-sample {
        font-size: 0.8rem;
        padding: 0.3rem 0.6rem;
        border-radius: 4px;
        background-color: var(--info-color);
        border-color: var(--info-color);
        color: white;
        transition: all 0.2s ease;
    }
    
    .btn-sample:hover {
        background-color: #138496;
        border-color: #117a8b;
        transform: translateY(-1px);
    }
    
    /* Image upload fields */
    .upload-card {
        border: 1px dashed #ced4da;
        border-radius: 8px;
        padding: 0.75rem;
        background-color: #f8f9fa;
        transition: all 0.2s ease;
    }
    
    .upload-card:hover {
        border-color: var(--primary-light);
        background-color: #f0f8ff;
    }
    
    /* Animation for the content */
    .content-section {
        animation: fadeIn 0.5s ease-in-out;
    }
    
    /* Modal styling */
    .custom-modal .modal-content {
        border-radius: 12px;
        border: none;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    
    .custom-modal .modal-header {
        background-color: var(--primary-color);
        color: white;
        border-radius: 12px 12px 0 0;
    }
    
    .custom-modal .modal-title {
        font-weight: 600;
    }
    
    .custom-modal .btn-close {
        color: white;
    }
</style>

<div class="container mt-4 fade-in">
    <div class="row">
        <div class="col-lg-8 offset-lg-2">
            <div class="row mb-4 align-items-center">
                <div class="col">
                    <h2 class="section-heading">
                        <i data-lucide="sprout" size="24"></i>
                        Add Species for {{ farmer.first_name }} {{ farmer.last_name }}
                    </h2>
                </div>
            </div>
            
            <!-- Success/Error Message Container -->
            <div id="message" class="mb-3"></div>
            
            <!-- Species Form -->
            <form id="specieForm" method="post" class="content-section" enctype="multipart/form-data">
                {% csrf_token %}
                
                <div class="card card-form">
                    <!-- Plantation Selection -->
                    <div class="mb-3">
                        <label for="plantationSelect" class="form-label">
                            <i data-lucide="layout-grid" size="16"></i> Select Plantation
                        </label>
                        <select id="plantationSelect" name="plantation_id" class="form-select" required>
                            {% if plantations|length > 1 %}
                                <option value="">-- Select Plantation --</option>
                                {% for plantation in plantations %}
                                    <option value="{{ plantation.id }}" {% if plantation.has_species %}disabled{% endif %}
                                        {% if plantation.id == first_plantation_id %}selected{% endif %}>
                                        {{ plantation.kyari_name }} (Farm: {{ plantation.farm.farm_name }})
                                    </option>
                                {% endfor %}
                            {% elif plantations %}
                                <!-- If only one plantation exists, auto-select it -->
                                <option value="{{ plantations.first.id }}" selected>
                                    {{ plantations.first.kyari_name }} (Farm: {{ plantations.first.farm.farm_name }})
                                </option>
                            {% else %}
                                <option value="" disabled>No plantations available</option>
                            {% endif %}
                        </select>
                    </div>
                    
                    <!-- Species Selection -->
                    <div class="mb-3">
                        <label for="specieSelect" class="form-label">
                            <i data-lucide="flower" size="16"></i> Select Species
                        </label>
                        <select id="specieSelect" name="specie_id" class="form-select" required>
                            <option value="">-- Select Species --</option>
                        </select>
                    </div>
                    
                    <!-- Number of Plants -->
                    <div class="mb-3">
                        <label for="{{ form.number_of_plants.id_for_label }}" class="form-label">
                            <i data-lucide="hash" size="16"></i> Number of Plants
                        </label>
                        {{ form.number_of_plants }}
                        {% if form.number_of_plants.errors %}
                            <div class="text-danger">
                                {% for error in form.number_of_plants.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Plant Spacing -->
                    <div class="mb-3">
                        <label for="{{ form.plant_spacing.id_for_label }}" class="form-label">
                            <i data-lucide="move" size="16"></i> Plant Spacing (e.g., "3_3")
                        </label>
                        {{ form.plant_spacing }}
                        {% if form.plant_spacing.errors %}
                            <div class="text-danger">
                                {% for error in form.plant_spacing.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Custom Spacing Section -->
                    <h4 class="subsection-heading">
                        <i data-lucide="move-horizontal" size="18"></i> Custom Spacing
                    </h4>
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label for="{{ form.spacing_cr.id_for_label }}" class="form-label">
                                <i data-lucide="arrow-right" size="14"></i> Spacing Right
                            </label>
                            {{ form.spacing_cr }}
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="{{ form.spacing_cl.id_for_label }}" class="form-label">
                                <i data-lucide="arrow-left" size="14"></i> Spacing Left
                            </label>
                            {{ form.spacing_cl }}
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="{{ form.spacing_ct.id_for_label }}" class="form-label">
                                <i data-lucide="arrow-up" size="14"></i> Spacing Top
                            </label>
                            {{ form.spacing_ct }}
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="{{ form.spacing_cb.id_for_label }}" class="form-label">
                                <i data-lucide="arrow-down" size="14"></i> Spacing Bottom
                            </label>
                            {{ form.spacing_cb }}
                        </div>
                    </div>
                    
                    <!-- Upload Images Section -->
                    <h4 class="subsection-heading">
                        <i data-lucide="image" size="18"></i> Upload Images
                    </h4>
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <div class="upload-card">
                                <label for="{{ form.centre_top.id_for_label }}" class="form-label">
                                    Centre Top
                                </label>
                                {{ form.centre_top }}
                                <button type="button" class="btn btn-sample mt-2" onclick="showSample('top')">
                                    <i data-lucide="eye" size="14"></i> View Sample
                                </button>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="upload-card">
                                <label for="{{ form.centre_bottom.id_for_label }}" class="form-label">
                                    Centre Bottom
                                </label>
                                {{ form.centre_bottom }}
                                <button type="button" class="btn btn-sample mt-2" onclick="showSample('bottom')">
                                    <i data-lucide="eye" size="14"></i> View Sample
                                </button>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="upload-card">
                                <label for="{{ form.centre_left.id_for_label }}" class="form-label">
                                    Centre Left
                                </label>
                                {{ form.centre_left }}
                                <button type="button" class="btn btn-sample mt-2" onclick="showSample('left')">
                                    <i data-lucide="eye" size="14"></i> View Sample
                                </button>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="upload-card">
                                <label for="{{ form.centre_right.id_for_label }}" class="form-label">
                                    Centre Right
                                </label>
                                {{ form.centre_right }}
                                <button type="button" class="btn btn-sample mt-2" onclick="showSample('right')">
                                    <i data-lucide="eye" size="14"></i> View Sample
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Plantation Date -->
                    <div class="mb-3 mt-3">
                        <label for="plantationDate" class="form-label">
                            <i data-lucide="calendar" size="16"></i> Plantation Date
                        </label>
                        <input type="date" id="plantationDate" name="plantation_date" class="form-control" required>
                    </div>
                </div>
                
                <!-- Submit Buttons -->
                <div class="row mt-4">
                    <div class="col-md-6 mb-3">
                        <button type="submit" class="btn btn-success btn-action w-100" id="submitAndGoNext">
                            <i data-lucide="check-circle" size="18"></i> Save & Proceed
                        </button>
                    </div>
                    <div class="col-md-6 mb-3">
                        <button type="submit" class="btn btn-primary btn-action w-100" id="submitAndAddMore">
                            <i data-lucide="plus-circle" size="18"></i> Save & Add More Species
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Sample Image Modal with enhanced styling -->
<div class="modal fade custom-modal" id="sampleImageModal" tabindex="-1" aria-labelledby="sampleImageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="sampleImageModalLabel">
                    <i data-lucide="image" size="18"></i> Sample Image
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center p-4">
                <img id="sampleImage" src="" class="img-fluid rounded" alt="Sample Image">
            </div>
        </div>
    </div>
</div>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        let plantSpacingField = document.getElementById("id_plant_spacing");
        let spacingCR = document.getElementById("id_spacing_cr");
        let spacingCL = document.getElementById("id_spacing_cl");
        let spacingCT = document.getElementById("id_spacing_ct");
        let spacingCB = document.getElementById("id_spacing_cb");

        function updateSpacing() {
            let value = plantSpacingField.value.trim(); // Get selected spacing
            let parts = value.split("_"); // Split value into two numbers
            
            if (parts.length === 2) {
                let topBottom = parseInt(parts[0]);  // First part (Top/Bottom)
                let leftRight = parseInt(parts[1]);  // Second part (Left/Right)

                if (!isNaN(topBottom) && !isNaN(leftRight)) {
                    spacingCT.value = topBottom;  // Set Top Spacing
                    spacingCB.value = topBottom;  // Set Bottom Spacing
                    spacingCR.value = leftRight;  // Set Right Spacing
                    spacingCL.value = leftRight;  // Set Left Spacing
                }
            }
        }

        // Trigger on selection change
        plantSpacingField.addEventListener("change", updateSpacing);
    });
</script>

<script>
    function compressImage(file, quality, maxWidth, callback) {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = function(event) {
            const img = new Image();
            img.src = event.target.result;
            img.onload = function() {
                let width = img.width;
                let height = img.height;
                if (width > maxWidth) {
                    height = (maxWidth / width) * height;
                    width = maxWidth;
                }
                
                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                
                canvas.toBlob(function(blob) {
                    const compressedFile = new File([blob], file.name, {
                        type: 'image/jpeg',
                        lastModified: Date.now()
                    });
                    callback(compressedFile);
                }, 'image/jpeg', quality);
            };
        };
    }

    // Apply compression to all relevant image inputs
    document.querySelectorAll('input[type="file"][accept*="image"]').forEach(input => {
        input.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            if (!file.type.startsWith('image/')) return;

            const label = this.previousElementSibling;
            const originalLabelText = label.textContent;
            label.textContent = `${originalLabelText} (Compressing...)`;

            compressImage(file, 0.6, 1280, (compressedFile) => {
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(compressedFile);
                this.files = dataTransfer.files;

                label.textContent = originalLabelText;
                console.log(`Compressed ${file.name} from ${Math.round(file.size/1024)}KB to ${Math.round(compressedFile.size/1024)}KB`);
            });
        });
    });
</script>
<script>
    function showSample(position) {
        let sampleImages = {
            "top": "/static/sample_images/centre_top.jpg",
            "bottom": "/static/sample_images/centre_bottom.jpg",
            "left": "/static/sample_images/centre_left.jpg",
            "right": "/static/sample_images/centre_right.jpg"
        };

        document.getElementById("sampleImage").src = sampleImages[position];

        // Show modal using Bootstrap 5 method
        var modal = new bootstrap.Modal(document.getElementById("sampleImageModal"));
        modal.show();
    }
</script>

<!-- AJAX Form Submission -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const specieForm = document.getElementById("specieForm");
        const messageDiv = document.getElementById("message");
    
        // Get the farmer ID from the context (e.g., passed via Django template)
        const farmerId = {{ farmer.id }}; // Ensure this is correctly passed from the backend
    
        // Function to handle form submission
        async function handleSubmit(event, action) {
            event.preventDefault();
    
            // Show loading message and hide the form
            specieForm.style.display = "none";
            messageDiv.innerHTML = `
                <div class="alert alert-info">
                    Uploading data, please wait...
                </div>
            `;
    
            try {
                // Gather form data
                const formData = new FormData(specieForm);
    
                // Send AJAX request with the farmer ID included in the URL
                const response = await fetch(`/add-species/${farmerId}/`, { // Include farmerId in the URL
                    method: "POST",
                    body: formData,
                    headers: { "X-Requested-With": "XMLHttpRequest" }
                });
    
                const data = await response.json();
    
                if (data.success) {
                    // Success message with further instructions
                    messageDiv.innerHTML = `
                        <div class="alert alert-success mt-3">
                            <p>✅ Species added successfully!</p>
                        </div>
                    `;
    
                    // Perform action based on the button clicked
                    if (action === "goNext") {
                        window.location.href = `/upload-media/${farmerId}/`;
                    } else if (action === "addMore") {
                        specieForm.reset();
                        messageDiv.innerHTML = "";
                        specieForm.style.display = "block";
                    }
                } else {
                    // Display error message
                    messageDiv.innerHTML = `
                        <div class="alert alert-danger">
                            Error: ${data.errors || "Unknown error"}
                        </div>
                    `;
                    specieForm.style.display = "block"; // Re-enable the form
                }
            } catch (error) {
                console.error("Error:", error);
                messageDiv.innerHTML = `
                    <div class="alert alert-danger">
                        An unexpected error occurred. Please try again.
                    </div>
                `;
                specieForm.style.display = "block"; // Re-enable the form
            }
        }
    
        // Add event listeners for both buttons
        document.getElementById("submitAndGoNext").addEventListener("click", function (event) {
            handleSubmit(event, "goNext");
        });
    
        document.getElementById("submitAndAddMore").addEventListener("click", function (event) {
            handleSubmit(event, "addMore");
        });
    });
    document.addEventListener("DOMContentLoaded", function () {
        const specieSelect = document.getElementById("specieSelect");
    
        // Fetch species data from the backend
        fetch("/api/plantation/species/all/")
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // Populate the species dropdown
                data.forEach(specie => {
                    const option = document.createElement("option");
                    option.value = specie.id;
                    option.textContent = specie.display_name;
                    specieSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error("Error fetching species data:", error);
                alert("Failed to load species data. Please try again later.");
            });
    
    });
</script>

{% endblock %}