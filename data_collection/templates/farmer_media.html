{% extends "data_collection/templates/base.html" %}
{% load static %}
{% block content %}
<div class="container mt-4">
    <h2 class="mb-3 text-primary">Upload Media for {{ farmer.first_name }} {{ farmer.last_name }}</h2>
    
    <!-- Success/Error Message Placeholder -->
    <div id="message"></div>
    {% if error %}
    <div class="alert alert-danger">
        {{ error }}
    </div>
    {% endif %}
    
    <!-- Media Upload Form -->
    <form id="mediaUploadForm" method="post" enctype="multipart/form-data" class="card p-4 shadow">
        {% csrf_token %}
        
        <div class="row mb-4">
            <!-- Farmer's Picture -->
            <div class="col-md-6 mb-3">
                <label class="form-label">Farmer's Picture</label>
                <div class="input-group">
                    <input type="file" id="farmerPicture" name="picture" accept="image/*" class="form-control" onchange="previewImage(this, 'farmerPicturePreview')">
                    <button class="btn btn-outline-secondary" type="button" onclick="activateCamera('farmerPicture')">
                        <i data-lucide="camera" size="18"></i>
                    </button>
                </div>
                <div class="mt-2 preview-container" style="height: 150px; display: flex; align-items: center; justify-content: center; border: 1px dashed #ccc; border-radius: 6px; overflow: hidden;">
                    <img id="farmerPicturePreview" src="#" alt="Preview" style="max-height: 140px; max-width: 100%; object-fit: contain; display: none;">
                    <span class="preview-placeholder">Preview will appear here</span>
                </div>
            </div>
            
            <!-- ID Information -->
            <div class="col-md-6 mb-3">
                <label class="form-label">ID Card Type</label>
                <select id="idType" name="id_type" class="form-select mb-3" onchange="toggleExpiryDate()">
                    <option value="">-- Select ID Type --</option>
                    <option value="aadhar">Aadhar Card</option>
                    <option value="driving_licence">Driving License</option>
                    <option value="voter_id">Voter ID</option>
                    <option value="pan_card">PAN Card</option>
                </select>
                
                <label class="form-label">ID Number</label>
                <input type="text" id="idNumber" name="id_number" class="form-control mb-3" placeholder="Enter ID Number">
                
                <div id="expiryDateField" style="display: none;">
                    <label class="form-label">Expiry Date</label>
                    <input type="date" id="idExpiryDate" name="id_expiry_date" class="form-control">
                </div>
            </div>
        </div>
        
        <!-- ID Proof Images -->
        <div class="row mb-4">
            <div class="col-md-6 mb-3">
                <label class="form-label">ID Card Front</label>
                <div class="input-group">
                    <input type="file" id="idProofFront" name="id_proof_front" accept="image/*" class="form-control" onchange="previewImage(this, 'idProofFrontPreview')">
                    <button class="btn btn-outline-secondary" type="button" onclick="activateCamera('idProofFront')">
                        <i data-lucide="camera" size="18"></i>
                    </button>
                </div>
                <div class="mt-2 preview-container" style="height: 150px; display: flex; align-items: center; justify-content: center; border: 1px dashed #ccc; border-radius: 6px; overflow: hidden;">
                    <img id="idProofFrontPreview" src="#" alt="Preview" style="max-height: 140px; max-width: 100%; object-fit: contain; display: none;">
                    <span class="preview-placeholder">Preview will appear here</span>
                </div>
            </div>
            
            <div class="col-md-6 mb-3">
                <label class="form-label">ID Card Back</label>
                <div class="input-group">
                    <input type="file" id="idProofBack" name="id_proof_back" accept="image/*" class="form-control" onchange="previewImage(this, 'idProofBackPreview')">
                    <button class="btn btn-outline-secondary" type="button" onclick="activateCamera('idProofBack')">
                        <i data-lucide="camera" size="18"></i>
                    </button>
                </div>
                <div class="mt-2 preview-container" style="height: 150px; display: flex; align-items: center; justify-content: center; border: 1px dashed #ccc; border-radius: 6px; overflow: hidden;">
                    <img id="idProofBackPreview" src="#" alt="Preview" style="max-height: 140px; max-width: 100%; object-fit: contain; display: none;">
                    <span class="preview-placeholder">Preview will appear here</span>
                </div>
            </div>
        </div>
        
        <!-- EPIC Images -->
        <div class="row mb-4">
            <div class="col-md-6 mb-3">
                <label class="form-label">Photo of English EPIC</label>
                <div class="input-group">
                    <input type="file" id="photoOfEnglishEpic" name="photo_of_english_epic" accept="image/*" class="form-control" onchange="previewImage(this, 'englishEpicPreview')">
                    <button class="btn btn-outline-secondary" type="button" onclick="activateCamera('photoOfEnglishEpic')">
                        <i data-lucide="camera" size="18"></i>
                    </button>
                </div>
                <div class="mt-2 preview-container" style="height: 150px; display: flex; align-items: center; justify-content: center; border: 1px dashed #ccc; border-radius: 6px; overflow: hidden;">
                    <img id="englishEpicPreview" src="#" alt="Preview" style="max-height: 140px; max-width: 100%; object-fit: contain; display: none;">
                    <span class="preview-placeholder">Preview will appear here</span>
                </div>
            </div>
            
            <div class="col-md-6 mb-3">
                <label class="form-label">Photo of Regional Language EPIC</label>
                <div class="input-group">
                    <input type="file" id="photoOfRegionalLanguageEpic" name="photo_of_regional_language_epic" accept="image/*" class="form-control" onchange="previewImage(this, 'regionalEpicPreview')">
                    <button class="btn btn-outline-secondary" type="button" onclick="activateCamera('photoOfRegionalLanguageEpic')">
                        <i data-lucide="camera" size="18"></i>
                    </button>
                </div>
                <div class="mt-2 preview-container" style="height: 150px; display: flex; align-items: center; justify-content: center; border: 1px dashed #ccc; border-radius: 6px; overflow: hidden;">
                    <img id="regionalEpicPreview" src="#" alt="Preview" style="max-height: 140px; max-width: 100%; object-fit: contain; display: none;">
                    <span class="preview-placeholder">Preview will appear here</span>
                </div>
            </div>
        </div>
        
        <!-- Digital Signature -->
        <div class="mb-4">
            <label class="form-label">Draw Signature</label>
            <div class="card p-3">
                <div id="signatureContainer" style="position: relative;">
                    <small class="text-muted mb-2 d-block">Sign with your finger or stylus</small>
                    <canvas id="signatureCanvas" style="width: 100%; height: 150px; border: 1px solid #ccc; border-radius: 6px;"></canvas>
                </div>
                <div class="mt-2 d-flex justify-content-end">
                    <button type="button" id="clearSignature" class="btn btn-sm btn-danger">
                        <i data-lucide="trash-2" size="16"></i> Clear
                    </button>
                </div>
                <input type="hidden" id="signatureData" name="digital_signature">
            </div>
        </div>
        
        <!-- Submit Button -->
        <div class="d-grid gap-2">
            <button type="submit" class="btn btn-success py-2">
                <i data-lucide="upload-cloud" size="18"></i> Upload Media
            </button>
        </div>
    </form>
</div>
<script>
    // Function to preview uploaded images
    function previewImage(input, previewId) {
        const preview = document.getElementById(previewId);
        const previewContainer = preview.parentElement;
        const placeholder = previewContainer.querySelector('.preview-placeholder');
        
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                preview.src = e.target.result;
                preview.style.display = 'block';
                if (placeholder) placeholder.style.display = 'none';
            }
            
            reader.readAsDataURL(input.files[0]);
        } else {
            preview.style.display = 'none';
            if (placeholder) placeholder.style.display = 'block';
        }
    }
    
    // Function to activate camera
    function activateCamera(inputId) {
        document.getElementById(inputId).click();
    }
    
    // Toggle expiry date field based on ID type
    function toggleExpiryDate() {
        const idType = document.getElementById('idType').value;
        const expiryField = document.getElementById('expiryDateField');
        
        if (idType === 'driving_licence') {
            expiryField.style.display = 'block';
        } else {
            expiryField.style.display = 'none';
        }
    }
</script>
<!-- Signature Pad Script -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // ============== ENHANCED SIGNATURE PAD CODE ==============
        const canvas = document.getElementById("signatureCanvas");
        const ctx = canvas.getContext("2d");
        const signatureStatusMsg = document.querySelector("#signatureContainer .text-muted");
        
        // Set canvas dimensions properly based on the container size
        function resizeCanvas() {
            const container = canvas.parentElement;
            const containerWidth = container.clientWidth - 2; // Subtract border width
            const containerHeight = parseInt(canvas.style.height) || 150;
            
            // Set the display size (CSS)
            canvas.style.width = containerWidth + 'px';
            canvas.style.height = containerHeight + 'px';
            
            // Set the actual size in memory (scaled for high DPI)
            const dpr = window.devicePixelRatio || 1;
            canvas.width = containerWidth * dpr;
            canvas.height = containerHeight * dpr;
            
            // Scale context to match DPI
            ctx.scale(dpr, dpr);
            
            // Reset the context for proper drawing
            ctx.lineWidth = isMobile ? 3 : 2; // Slightly thicker lines on mobile
            ctx.lineCap = "round";
            ctx.lineJoin = "round";
            ctx.strokeStyle = "#000000";
            
            // Draw watermark if no signature exists
            if (!document.getElementById("signatureData").value) {
                drawWatermark();
            }
        }
        
        // Add a "Sign Here" watermark for empty canvas
        function drawWatermark() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.save();
            ctx.font = "16px Arial";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillStyle = "#cccccc";
            ctx.fillText("Sign Here", canvas.width / (2 * (window.devicePixelRatio || 1)), 
                         canvas.height / (2 * (window.devicePixelRatio || 1)));
            ctx.restore();
        }
        
        // Check if user is on mobile device
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        // Initialize canvas size
        resizeCanvas();
        
        // Resize canvas when window changes
        window.addEventListener('resize', resizeCanvas);
        
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        
        // Prevent scrolling when touching the canvas on mobile
        canvas.addEventListener('touchstart', function(e) {
            if (e.target === canvas) {
                e.preventDefault();
            }
        }, { passive: false });
        
        canvas.addEventListener('touchmove', function(e) {
            if (e.target === canvas) {
                e.preventDefault();
            }
        }, { passive: false });
        
        // Start drawing
        function startDrawing(e) {
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            const dpr = window.devicePixelRatio || 1;
            
            // Clear watermark on first draw
            if (document.getElementById("signatureData").value === "") {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
            
            // Get coordinates
            let clientX, clientY;
            if (e.type === 'touchstart' || e.type === 'touchmove') {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }
            
            lastX = (clientX - rect.left) * (canvas.width / rect.width / dpr);
            lastY = (clientY - rect.top) * (canvas.height / rect.height / dpr);
            
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
        }
        
        // Continue drawing
        function draw(e) {
            if (!isDrawing) return;
            
            const rect = canvas.getBoundingClientRect();
            const dpr = window.devicePixelRatio || 1;
            
            let clientX, clientY;
            if (e.type === 'touchstart' || e.type === 'touchmove') {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }
            
            const currentX = (clientX - rect.left) * (canvas.width / rect.width / dpr);
            const currentY = (clientY - rect.top) * (canvas.height / rect.height / dpr);
            
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(currentX, currentY);
            ctx.stroke();
            
            lastX = currentX;
            lastY = currentY;
        }
        
        // Stop drawing
        function stopDrawing() {
            if (isDrawing) {
                isDrawing = false;
                ctx.closePath();
                
                // Save the signature as a base64-encoded image
                const signatureData = canvas.toDataURL("image/png");
                document.getElementById("signatureData").value = signatureData;
                
                // Add visual feedback that signature was saved
                signatureStatusMsg.className = "text-success mb-2 d-block";
                signatureStatusMsg.textContent = "✓ Signature saved";
                setTimeout(() => {
                    signatureStatusMsg.className = "text-muted mb-2 d-block";
                    signatureStatusMsg.textContent = "Sign with your finger or stylus";
                }, 1500);
            }
        }
        
        // Handle touch events for mobile
        canvas.addEventListener("touchstart", startDrawing);
        canvas.addEventListener("touchmove", draw);
        canvas.addEventListener("touchend", stopDrawing);
        
        // Handle mouse events for desktop
        canvas.addEventListener("mousedown", startDrawing);
        canvas.addEventListener("mousemove", draw);
        canvas.addEventListener("mouseup", stopDrawing);
        canvas.addEventListener("mouseout", stopDrawing);
        
        // Clear button functionality
        document.getElementById("clearSignature").addEventListener("click", function () {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            document.getElementById("signatureData").value = "";
            drawWatermark();
            signatureStatusMsg.className = "text-muted mb-2 d-block";
            signatureStatusMsg.textContent = "Sign with your finger or stylus";
        });

        // ============== REST OF YOUR SCRIPT FOLLOWS ==============

        // ============== FIXED IMAGE COMPRESSION FUNCTION ==============
        function compressImage(file, quality, maxWidth, callback) {
            // Check if file exists and is an image
            if (!file || !file.type.startsWith('image/')) {
                callback(file); // Return original file if not an image
                return;
            }
            
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = function(event) {
                const img = new Image();
                img.src = event.target.result;
                img.onload = function() {
                    // Calculate new dimensions while maintaining aspect ratio
                    let width = img.width;
                    let height = img.height;
                    if (width > maxWidth) {
                        height = (maxWidth / width) * height;
                        width = maxWidth;
                    }
                    
                    // Create canvas and context
                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    
                    // Draw and compress image
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Convert to Blob
                    canvas.toBlob(function(blob) {
                        if (blob) {
                            // Create new File object
                            const compressedFile = new File([blob], file.name, {
                                type: 'image/jpeg',
                                lastModified: Date.now()
                            });
                            
                            // Update compression status
                            console.log(`Compressed ${file.name}: ${Math.round(file.size/1024)}KB → ${Math.round(compressedFile.size/1024)}KB`);
                            
                            callback(compressedFile);
                        } else {
                            // Fall back to original file if compression fails
                            console.log(`Compression failed for ${file.name}, using original`);
                            callback(file);
                        }
                    }, 'image/jpeg', quality);
                };
                
                // Handle image loading errors
                img.onerror = function() {
                    console.log(`Failed to load image ${file.name}, using original`);
                    callback(file);
                };
            };
            
            // Handle file reading errors
            reader.onerror = function() {
                console.log(`Failed to read file ${file.name}, using original`);
                callback(file);
            };
        }
        
        // Add compression to all image inputs
        const imageInputs = document.querySelectorAll('input[type="file"][accept*="image"]');
        
        imageInputs.forEach(input => {
            const originalOnChange = input.onchange;
            
            input.onchange = function(e) {
                const file = this.files[0];
                if (!file) return;
                
                // Skip if not an image
                if (!file.type.startsWith('image/')) {
                    if (originalOnChange) originalOnChange.call(this, e);
                    return;
                }
                
                // Store input reference for later
                const fileInput = this;
                const inputId = fileInput.id;
                const previewId = inputId + 'Preview';
                
                // Show compression indicator
                const previewContainer = document.getElementById(previewId).parentElement;
                const placeholder = previewContainer.querySelector('.preview-placeholder');
                placeholder.textContent = "Compressing...";
                
                // Apply compression
                compressImage(file, 0.6, 1280, (compressedFile) => {
                    // Create a new file list with the compressed image
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(compressedFile);
                    fileInput.files = dataTransfer.files;
                    
                    // Now update the preview
                    previewImage(fileInput, previewId);
                });
            };
        });
    
        // ============== FORM SUBMISSION ==============
        document.getElementById("mediaUploadForm").addEventListener("submit", function (event) {
            event.preventDefault();
            
            // Validate required fields
            const idProofFront = document.getElementById("idProofFront").files[0];
            const idProofBack = document.getElementById("idProofBack").files[0];
            const signatureData = document.getElementById("signatureData").value;
    
            if (!idProofFront || !idProofBack) {
                document.getElementById("message").innerHTML = `
                    <div class="alert alert-danger">
                        Please upload both the front and back sides of the ID card.
                    </div>
                `;
                return;
            }
    
            // Show loading indicator and hide the form
            document.getElementById("mediaUploadForm").style.display = "none";
            document.getElementById("message").innerHTML = `
                <div class="alert alert-info">
                    <div class="d-flex align-items-center">
                        <div class="spinner-border text-primary me-2" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <span>Uploading files, please wait...</span>
                    </div>
                </div>
            `;
    
            // Create FormData object
            const formData = new FormData(this);
            
            // Send AJAX request
            fetch(this.action || window.location.href, {
                method: "POST",
                body: formData,
                headers: { "X-Requested-With": "XMLHttpRequest" }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById("message").innerHTML = `
                        <div class="alert alert-success mt-3">
                            <p>✅ Farmer Registration Complete!</p>
                            <button id="addNewFarmerBtn" class="btn btn-primary mt-2">👨‍🌾 Add New Farmer</button>
                        </div>
                    `;
    
                    // Add event listeners for buttons
                    document.getElementById("addNewFarmerBtn").addEventListener("click", function () {
                        window.location.href = location.origin + "/";
                    });
                } else {
                    document.getElementById("message").innerHTML = `
                        <div class="alert alert-danger">
                            Error: ${data.errors || "Unknown error"}
                        </div>
                    `;
                    // Re-enable the form in case of an error
                    document.getElementById("mediaUploadForm").style.display = "block";
                }
            })
            .catch(error => {
                console.error("Error:", error);
                document.getElementById("message").innerHTML = `
                    <div class="alert alert-danger">
                        An unexpected error occurred. Please try again.
                    </div>
                `;
                // Re-enable the form in case of an error
                document.getElementById("mediaUploadForm").style.display = "block";
            });
        });
    });
</script>
{% endblock %}