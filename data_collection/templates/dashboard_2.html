{% extends "data_collection/templates/base.html" %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-3">📊 Farmer Sync Dashboard</h2>

    <!-- Progress Section -->
    <div id="sync-progress" class="alert alert-info">⏳ Loading sync status...</div>

    <div class="row">
        <!-- Pending Farmers -->
        <div class="col-md-6">
            <h3>❌ Pending Farmers</h3>
            <ul id="pendingFarmersList" class="list-group"></ul>
            <button id="syncAllButton" class="btn btn-primary mt-2">🔄 Sync All</button>
        </div>

        <!-- Synced Farmers -->
        <div class="col-md-6">
            <h3>✅ Synced Farmers</h3>
            <ul id="syncedFarmersList" class="list-group"></ul>
        </div>
    </div>
</div>

<script>
    function loadSyncStatus() {
        fetch("/api/sync-status/")
            .then(response => response.json())
            .then(data => {
                let pendingFarmersList = document.getElementById("pendingFarmersList");
                let syncedFarmersList = document.getElementById("syncedFarmersList");
                let progressDiv = document.getElementById("sync-progress");
    
                pendingFarmersList.innerHTML = "";
                syncedFarmersList.innerHTML = "";
    
                data.pending.forEach(farmer => {
                    let listItem = document.createElement("li");
                    listItem.className = "list-group-item d-flex justify-content-between align-items-center";
                    listItem.innerHTML = `<span>${farmer.name} - ${farmer.mobile}</span>
                        <button class="btn btn-warning btn-sm" onclick="syncFarmer(${farmer.id})">🔄 Sync</button>`;
                    pendingFarmersList.appendChild(listItem);
                });
    
                data.synced.forEach(farmer => {
                    let listItem = document.createElement("li");
                    listItem.className = "list-group-item list-group-item-success";
                    listItem.textContent = `${farmer.name} - ${farmer.mobile}`;
                    syncedFarmersList.appendChild(listItem);
                });
    
                let totalFarmers = data.pending.length + data.synced.length;
                let syncedPercentage = totalFarmers ? Math.round((data.synced.length / totalFarmers) * 100) : 0;
                progressDiv.innerHTML = `✅ ${syncedPercentage}% of farmers synced!`;
            })
            .catch(error => console.error("❌ Error loading sync status:", error));
    }
    
    // ✅ Load sync status when the page loads
    document.addEventListener("DOMContentLoaded", function () {
        loadSyncStatus();
    
        // ✅ Attach event listener to "Sync All" button
        document.getElementById("syncAllButton").addEventListener("click", function () {
            syncAllFarmers();
        });
    });
    
    // ✅ Function to get CSRF Token from Django
    function getCSRFToken() {
        return document.cookie.split("; ").find(row => row.startsWith("csrftoken="))?.split("=")[1] || "";
    }
    
    // ✅ Function to sync a single farmer
    function syncFarmer(farmerId) {
        fetch("/api/push-all-data/", {
            method: "POST",
            body: JSON.stringify({ farmers: [{ id: farmerId }] }),
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCSRFToken(),  // ✅ Add CSRF token
                "X-Requested-With": "XMLHttpRequest"
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert("✅ All pending farmers synced successfully!");
            } else {
                console.error("❌ Sync Errors:", data.errors);
                alert(`⚠️ Sync completed with errors:\n ${JSON.stringify(data.errors, null, 2)}`);
            }
            //alert("✅ Farmer synced successfully!");
            loadSyncStatus();  // ✅ Reload sync status
        })
        .catch(error => console.error("❌ Error syncing farmer:", error));
    }
    
    // ✅ Function to sync ALL pending farmers
    function syncAllFarmers() {
        // ✅ Fetch pending farmers first
        fetch("/api/sync-status/")
            .then(response => response.json())
            .then(data => {
                let pendingFarmers = data.pending.map(farmer => ({ id: farmer.id }));
    
                if (pendingFarmers.length === 0) {
                    alert("✅ All farmers are already synced!");
                    return;
                }
    
                // ✅ Send POST request with pending farmers
                fetch("/api/push-all-data/", {
                    method: "POST",
                    body: JSON.stringify({ farmers: pendingFarmers }),
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": getCSRFToken(),  // ✅ Include CSRF token
                        "X-Requested-With": "XMLHttpRequest"
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert("✅ All pending farmers synced successfully!");
                    } else {
                        console.error("❌ Sync Errors:", data.errors);
                        alert(`⚠️ Sync completed with errors:\n ${JSON.stringify(data.errors, null, 2)}`);
                    }
                    //alert("✅ All pending farmers synced successfully!");
                    loadSyncStatus();  // ✅ Reload sync status
                })
                .catch(error => console.error("❌ Error syncing all farmers:", error));
            })
            .catch(error => console.error("❌ Error fetching pending farmers:", error));
    }
    
    </script>
    
    
{% endblock %}
