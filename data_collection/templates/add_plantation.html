{% extends "data_collection/templates/base.html" %}
{% load static %}

{% block content %}

<style>
    /* Map styling with responsive heights */
    #map {
        width: 100%;
        height: 350px;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        margin-bottom: 1.5rem;
        transition: box-shadow 0.3s ease;
    }
    
    #map:hover {
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }
    
    /* Medium screens */
    @media (min-width: 768px) {
        #map {
            height: 400px;
        }
    }
    
    /* Large screens */
    @media (min-width: 992px) {
        #map {
            height: 480px;
        }
    }
    
    /* Extra large screens */
    @media (min-width: 1200px) {
        #map {
            height: 550px;
        }
    }
    
    /* Form styling - matching the base template */
    .form-section {
        margin-bottom: 2rem;
    }
    
    .section-heading {
        color: var(--primary-color);
        font-weight: 600;
        margin-bottom: 1.25rem;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .card-form {
        border: none;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .card-form:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }
    
    /* Form controls - matching base styles */
    .form-control, .form-select {
        padding: 0.6rem 1rem;
        border-radius: 6px;
        border: 1px solid #ced4da;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: var(--primary-light);
        box-shadow: 0 0 0 0.25rem rgba(41, 187, 137, 0.25);
    }
    
    /* Label styling */
    .form-label {
        font-weight: 500;
        margin-bottom: 0.5rem;
        color: var(--text-dark);
    }
    
    /* Button styling */
    .btn-action {
        font-weight: 500;
        border-radius: 6px;
        transition: all 0.2s ease;
        padding: 0.75rem 1.5rem;
        margin-top: 0.5rem;
    }
    
    .btn-action:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    /* Animation for the content */
    .content-section {
        animation: fadeIn 0.5s ease-in-out;
    }
</style>
   
<div class="container mt-4 fade-in">
    <div class="row mb-4 align-items-center">
        <div class="col">
            <h2 class="section-heading">
                <i data-lucide="sprout" size="24"></i>
                Add Plantation for {{ farmer.first_name }} {{ farmer.last_name }}
            </h2>
        </div>
    </div>
    
    <!-- Success/Error Message Container -->
    <div id="message" class="mb-3"></div>
    
    <!-- Plantation Form -->
    <form id="plantationForm" method="post" class="content-section">
        {% csrf_token %}
        
        <div class="row">
            <!-- Left Column - Form Fields -->
            <div class="col-lg-6 form-section">
                <div class="card card-form">
                    <!-- Farm Selection Dropdown -->
                    <div class="mb-3">
                        <label for="farmSelect" class="form-label">
                            <i data-lucide="home" size="16"></i> Select Farm
                        </label>
                        <select id="farmSelect" name="farm_id" class="form-select">
                            {% if farms|length > 1 %}
                                <option value="">-- Select Farm --</option>
                                {% for farm in farms %}
                                    <option value="{{ farm.id }}" data-boundary="{{ farm.boundary.geojson }}"
                                        {% if farm.id == first_farm_id %}selected{% endif %}>
                                        {{ farm.farm_name }}
                                    </option>
                                {% endfor %}
                            {% elif farms %}
                                <!-- If only one farm exists, auto-select -->
                                <option value="{{ farms.first.id }}" selected data-boundary="{{ farms.first.boundary.geojson }}">
                                    {{ farms.first.farm_name }}
                                </option>
                            {% endif %}
                        </select>
                    </div>
                    
                    <!-- Replace form.as_p with styled form fields -->
                    {% for field in form %}
                        <div class="mb-3">
                            <label for="{{ field.id_for_label }}" class="form-label">
                                {% if field.name == 'kyari_name' %}
                                    <i data-lucide="tag" size="16"></i>
                                {% elif field.name == 'area_in_acres' %}
                                    <i data-lucide="ruler" size="16"></i>
                                {% elif field.name == 'plantation_year' %}
                                    <i data-lucide="calendar" size="16"></i>
                                {% endif %}
                                {{ field.label }}
                            </label>
                            {{ field }}
                            {% if field.help_text %}
                                <div class="form-text text-muted">{{ field.help_text }}</div>
                            {% endif %}
                            {% if field.errors %}
                                <div class="text-danger">
                                    {% for error in field.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            </div>
            
            <!-- Right Column - Map -->
            <div class="col-lg-6 map-section">
                <div class="card card-form">
                    <h3 class="mb-3 section-heading">
                        <i data-lucide="map-pin" size="20"></i> Draw Plantation Boundary
                    </h3>
                    <div id="map"></div>
                    <div class="form-text text-muted mt-2">
                        <i data-lucide="info" size="14"></i> 
                        Click on the map to create boundary points for your plantation area
                    </div>
                    <input type="hidden" name="boundary" id="boundary">
                </div>
            </div>
        </div>
        
        <!-- Bottom Row - Action Buttons -->
        <div class="row mt-4">
            <div class="col-md-6 mb-3">
                <button type="submit" class="btn btn-success btn-action w-100" id="submitAndGoNext">
                    <i data-lucide="save" size="18"></i> Save & Proceed
                </button>
            </div>
            <div class="col-md-6 mb-3">
                <button type="submit" class="btn btn-primary btn-action w-100" id="submitAndAddMore">
                    <i data-lucide="plus-circle" size="18"></i> Save & Add Another
                </button>
            </div>
        </div>
    </form>
</div>


<!-- Leaflet & Turf.js -->
 <!-- Add this before your script -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Turf.js/6.5.0/turf.min.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>


<script>
    document.addEventListener("DOMContentLoaded", function() {
        let farmBoundaryLayer;
        let drawnItems = new L.FeatureGroup();
        let plantationBoundaries = new L.FeatureGroup();
        
        // Define Multiple Map Layers
        var streets = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' });
        var satellite = L.tileLayer('/tiles/s/{z}/{x}/{y}', {
            attribution: '&copy; Google Satellite',
            maxZoom: 22
        });
        
        var terrain = L.tileLayer('/tiles/p/{z}/{x}/{y}', {
            attribution: '&copy; Google Terrain',
            maxZoom: 22
        });
        
        var hybrid = L.tileLayer('/tiles/y/{z}/{x}/{y}', {
            attribution: '&copy; Google Hybrid',
            maxZoom: 22
        });
        var esri = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: '&copy; Esri World Imagery' });
    
        // Initialize Map
        let map = L.map("map", {
            center: [23.6157, 81.9195],
            zoom: 6,
            maxZoom: 22,
            layers: [hybrid] // Default layer
        });
    
        // Add Layer Switcher
        var baseMaps = {
            "Streets": streets,
            "Google Satellite": satellite,
            "Google Terrain": terrain,
            "Google Hybrid": hybrid,
            "Esri World Imagery": esri
        };
        
        var overlayMaps = {
            "Drawn Items": drawnItems,
            "Existing Plantations": plantationBoundaries
        };
        
        L.control.layers(baseMaps, overlayMaps).addTo(map);
    
        // Add FeatureGroups to map
        map.addLayer(drawnItems);
        map.addLayer(plantationBoundaries);
    
        // Create warning message container
        let warningContainer = document.createElement('div');
        warningContainer.id = 'boundary-warning';
        warningContainer.className = 'alert alert-danger mt-3';
        warningContainer.style.display = 'none';
        document.getElementById('map').parentNode.insertBefore(warningContainer, document.getElementById('map').nextSibling);

        document.getElementById("farmSelect").addEventListener("change", function() {
            let selectedOption = this.options[this.selectedIndex];
            let farmId = this.value;
            let boundaryGeoJSON = selectedOption.getAttribute("data-boundary");
        
            if (boundaryGeoJSON) {
                let boundary = JSON.parse(boundaryGeoJSON);
        
                // Remove previous farm boundary
                if (typeof farmBoundaryLayer !== "undefined" && farmBoundaryLayer) {
                    map.removeLayer(farmBoundaryLayer);
                }
        
                // Draw new farm boundary
                farmBoundaryLayer = L.geoJSON(boundary, { color: "blue", fillOpacity: 0.3 }).addTo(map);
                map.fitBounds(farmBoundaryLayer.getBounds(), { maxZoom: 18 });
        
                // Clear previously drawn items
                drawnItems.clearLayers();
        
                // Reset warning message
                let warningElement = document.getElementById("boundary-warning");
                if (warningElement) {
                    warningElement.style.display = "none";
                }
        
                // Load existing plantations for this farm
                loadPlantationsForFarm(farmId);
        
                // Setup drawing tools with validation
                setupDrawingTools(boundary);
            }
        });
    
        // Trigger the change event on page load if a farm is selected
        let farmSelect = document.getElementById("farmSelect");
        if (farmSelect && farmSelect.value) {
            // Use setTimeout to ensure the event fires after everything is loaded
            setTimeout(function() {
                farmSelect.dispatchEvent(new Event("change"));
            }, 100);
        }
        
        // Load existing plantations for a farm
        function loadPlantationsForFarm(farmId) {
            // Clear existing plantation boundaries
            plantationBoundaries.clearLayers();
            
            if (!farmId) return;
            
            fetch(`/get-plantations/${farmId}/`)
                .then(response => response.json())
                .then(data => {
                    // Add each plantation boundary to the map
                    data.plantations.forEach(plantation => {
                        try {
                            let boundary = JSON.parse(plantation.boundary);
                            let layer = L.geoJSON(boundary, {
                                color: "green",
                                fillOpacity: 0.2,
                                weight: 2
                            });
                            
                            // Store the GeoJSON boundary and plantation info for intersection checking
                            layer.plantationId = plantation.id;
                            layer.plantationName = plantation.kyari_name;
                            layer.boundary = boundary;
                            
                            // Add a popup with plantation info
                            layer.bindPopup(`
                                <strong>${plantation.kyari_name}</strong><br>
                                Area: ${plantation.area_in_acres} acres<br>
                                Year: ${plantation.year}<br>
                                Type: ${plantation.kyari_type}
                            `);
                            
                            plantationBoundaries.addLayer(layer);
                        } catch (e) {
                            console.error("Error parsing plantation boundary:", e);
                        }
                    });
                })
                .catch(error => console.error("Error loading plantations:", error));
        }
    
        // Enable Drawing Only Inside Selected Farm
        function setupDrawingTools(farmBoundary) {
            // Remove existing draw control if it exists
            if (map.drawControl) {
                map.removeControl(map.drawControl);
            }
    
            // Create a new Draw Control with improved options for polygon closing
            let drawControl = new L.Control.Draw({
                edit: { 
                    featureGroup: drawnItems 
                },
                draw: {
                    polygon: {
                        allowIntersection: false,
                        showArea: true,
                        drawError: {
                            color: '#e1e100',
                            message: '<strong>Error:</strong> Polygon edges cannot cross!'
                        },
                        shapeOptions: {
                            color: '#f357a1',
                            weight: 3
                        },
                        // Lower the tolerance to make it easier to complete polygons
                        touchRadius: 4,
                        guideLayers: []
                    },
                    marker: false,
                    polyline: false,
                    rectangle: {
                        shapeOptions: {
                            color: '#f357a1',
                            weight: 3
                        }
                    },
                    circle: true,
                    circlemarker: false
                }
            });
    
            // Add the new Draw Control to the map
            map.addControl(drawControl);
            map.drawControl = drawControl;
    
            // Clean up any leftover event handlers
            map.off(L.Draw.Event.CREATED);
            map.off(L.Draw.Event.EDITED);
            
            // Function to check if polygon intersects with existing plantations
            function checkPlantationIntersections(drawnPolygon) {
                let intersectsWithExisting = false;
                let intersectingPlantation = null;
                
                try {
                    // Create a turf polygon from the drawn shape
                    let drawnTurfPolygon = turf.polygon(drawnPolygon.geometry.coordinates);
                    
                    // Check against each existing plantation
                    plantationBoundaries.eachLayer(function(layer) {
                        if (intersectsWithExisting) return; // Skip if we already found an intersection
                        
                        if (layer.boundary) {
                            try {
                                // Create a turf polygon from the existing plantation
                                let existingTurfPolygon = turf.polygon(layer.boundary.coordinates);
                                
                                // Check for intersection (not just contains)
                                let intersects = turf.booleanIntersects(drawnTurfPolygon, existingTurfPolygon);
                                
                                if (intersects) {
                                    intersectsWithExisting = true;
                                    intersectingPlantation = layer;
                                }
                            } catch (e) {
                                console.error("Error checking intersection with plantation:", e);
                            }
                        }
                    });
                } catch (e) {
                    console.error("Error in intersection checking:", e);
                }
                
                return { intersects: intersectsWithExisting, plantation: intersectingPlantation };
            }
            
            // Handle polygon creation event with improved validation
            map.on(L.Draw.Event.CREATED, function (event) {
                let layer = event.layer;
                let drawnPolygon = layer.toGeoJSON();
                let warningContainer = document.getElementById('boundary-warning');
                
                // Reset warning
                warningContainer.style.display = 'none';
                warningContainer.innerHTML = '';
                
                try {
                    // Normalize the farm boundary GeoJSON format if needed
                    let farmPolygon;
                    if (farmBoundary.type === "Feature" && farmBoundary.geometry) {
                        farmPolygon = turf.polygon(farmBoundary.geometry.coordinates);
                    } else if (farmBoundary.coordinates) {
                        farmPolygon = turf.polygon(farmBoundary.coordinates);
                    } else {
                        throw new Error("Invalid farm boundary format");
                    }
                    
                    // Create turf polygon from drawn shape
                    let drawnPolygonGeom = turf.polygon(drawnPolygon.geometry.coordinates);
                    
                    // First check: Is the plantation fully within the farm boundary?
                    let isWithinFarm = turf.booleanContains(farmPolygon, drawnPolygonGeom);
                    
                    if (!isWithinFarm) {
                        warningContainer.innerHTML = '⚠️ The plantation boundary must be fully inside the farm boundary! Please redraw.';
                        warningContainer.style.display = 'block';
                        
                        // Style drawn polygon as invalid
                        layer.setStyle({
                            color: 'red',
                            fillColor: '#ff6666',
                            fillOpacity: 0.4
                        });
                        
                        drawnItems.clearLayers();
                        drawnItems.addLayer(layer);
                        
                        // Clear boundary value
                        document.getElementById("boundary").value = '';
                        return;
                    }
                    
                    // Second check: Does the plantation intersect with any existing plantation?
                    let intersectionCheck = checkPlantationIntersections(drawnPolygon);
                    
                    if (intersectionCheck.intersects) {
                        warningContainer.innerHTML = `⚠️ This plantation boundary overlaps with existing plantation "${intersectionCheck.plantation.plantationName}"! Please redraw.`;
                        warningContainer.style.display = 'block';
                        
                        // Style drawn polygon as invalid
                        layer.setStyle({
                            color: 'red',
                            fillColor: '#ff6666',
                            fillOpacity: 0.4
                        });
                        
                        // Highlight the intersecting plantation
                        intersectionCheck.plantation.setStyle({
                            color: 'orange',
                            weight: 3,
                            fillOpacity: 0.4
                        });
                        
                        intersectionCheck.plantation.openPopup();
                        
                        drawnItems.clearLayers();
                        drawnItems.addLayer(layer);
                        
                        // Clear boundary value
                        document.getElementById("boundary").value = '';
                        return;
                    }
                    
                    // If we reach here, the boundary is valid!
                    
                    // Calculate area in acres
                    let area = calculateAreaInAcres(drawnPolygon);
                    document.getElementById("id_area_in_acres").value = area.toFixed(2);
    
                    // Add the valid polygon to the map with a green style
                    drawnItems.clearLayers(); // Clear previous drawings
                    layer.setStyle({
                        color: '#4CAF50',
                        fillColor: '#81C784',
                        fillOpacity: 0.5,
                        weight: 2
                    });
                    drawnItems.addLayer(layer);
    
                    // Store the valid polygon in the hidden input field
                    document.getElementById("boundary").value = JSON.stringify(drawnPolygon.geometry);
                    
                    console.log("Validation passed! Polygon is valid.");
                    
                    // Show success message
                    warningContainer.innerHTML = '✅ Valid plantation boundary! You can now submit the form.';
                    warningContainer.className = 'alert alert-success mt-3';
                    warningContainer.style.display = 'block';
                    
                    // Reset plantation styles if they were highlighted
                    plantationBoundaries.eachLayer(function(layer) {
                        layer.setStyle({
                            color: "green",
                            fillOpacity: 0.2,
                            weight: 2
                        });
                    });
                    
                    // Button to allow reset
                    let resetButton = document.createElement('button');
                    resetButton.className = 'btn btn-sm btn-outline-primary ml-2 float-end';
                    resetButton.innerText = 'Redraw';
                    resetButton.onclick = function() {
                        drawnItems.clearLayers();
                        document.getElementById("boundary").value = '';
                        warningContainer.style.display = 'none';
                        warningContainer.className = 'alert alert-danger mt-3';
                        return false;
                    };
                    warningContainer.appendChild(resetButton);
                    
                } catch (error) {
                    console.error("Validation error:", error);
                    warningContainer.innerHTML = "⚠️ Error validating boundary. Please try again.";
                    warningContainer.style.display = 'block';
                    document.getElementById("boundary").value = '';
                }
            });
            
            // Clear warnings when starting a new drawing
            map.on(L.Draw.Event.DRAWSTART, function() {
                document.getElementById('boundary-warning').style.display = 'none';
                
                // Reset plantation styles
                plantationBoundaries.eachLayer(function(layer) {
                    layer.setStyle({
                        color: "green",
                        fillOpacity: 0.2,
                        weight: 2
                    });
                });
            });
        }
    
        // Calculate area in acres from GeoJSON
        function calculateAreaInAcres(polygon) {
            try {
                // Calculate area in square meters
                let area = turf.area(polygon);
                // Convert to acres (1 sq meter = 0.000247105 acres)
                return area * 0.000247105;
            } catch (error) {
                console.error("Area calculation error:", error);
                return 0;
            }
        }
    
        // Handle form submission
        // Define farmerId from the Django template context
        var farmerId = {{ farmer.id }};
        console.log("Farmer ID:", farmerId); // Debugging: Log the farmerId to confirm it's set
    
        // Add event listeners for both buttons
        document.getElementById("submitAndGoNext").addEventListener("click", function (event) {
            handleSubmit(event, "goNext");
        });

        document.getElementById("submitAndAddMore").addEventListener("click", function (event) {
            handleSubmit(event, "addMore");
        });

        // Function to handle form submission
        async function handleSubmit(event, action) {
            event.preventDefault();

            // Get boundary data
            let boundaryData = document.getElementById("boundary").value;

            if (!boundaryData || boundaryData === "null" || boundaryData === "undefined") {
                alert("⚠️ You must draw a plantation boundary before submitting!");
                return;
            }

            // Additional validation before submission
            let warningVisible = document.getElementById('boundary-warning').style.display !== 'none' && 
                                document.getElementById('boundary-warning').className.includes('alert-danger');
            
            if (warningVisible) {
                alert("⚠️ Please fix the boundary issues before submitting!");
                return;
            }

            // Validate farmerId before proceeding
            if (!farmerId || farmerId === "undefined" || farmerId === "null") {
                alert("⚠️ Farmer ID is missing or invalid. Please refresh the page.");
                return;
            }

            // Show loading message and hide the form
            document.getElementById("plantationForm").style.display = "none";
            const messageDiv = document.getElementById("message");
            messageDiv.innerHTML = `
                <div class="alert alert-info">
                    Uploading data, please wait...
                </div>
            `;

            try {
                // Gather form data
                const formData = new FormData(document.getElementById("plantationForm"));

                // Send AJAX request with the farmer ID included in the URL
                const response = await fetch(`/add-plantation/${farmerId}/`, {
                    method: "POST",
                    body: formData,
                    headers: { "X-Requested-With": "XMLHttpRequest" }
                });

                const data = await response.json();

                if (data.success) {
                    // Success message
                    messageDiv.innerHTML = `
                        <div class="alert alert-success mt-3">
                            <p>✅ Plantation added successfully!</p>
                        </div>
                    `;

                    // Perform action based on the button clicked
                    if (action === "goNext") {
                        window.location.href = `/add-species/${farmerId}/`;
                    } else if (action === "addMore") {
                        // Reload the page to reflect the newly added plantation
                        setTimeout(() => {
                            location.reload();
                        }, 1000); // Optional delay to show success message briefly
                    }
                } else {
                    // Display error message
                    messageDiv.innerHTML = `
                        <div class="alert alert-danger">
                            Error: ${data.errors || "Unknown error"}
                        </div>
                    `;
                    document.getElementById("plantationForm").style.display = "block"; // Re-enable the form
                }
            } catch (error) {
                console.error("Error:", error);
                messageDiv.innerHTML = `
                    <div class="alert alert-danger">
                        An unexpected error occurred. Please try again.
                    </div>
                `;
                document.getElementById("plantationForm").style.display = "block"; // Re-enable the form
            }
        }
    });
</script>
{% endblock %}
